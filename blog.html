// Tag Filtering System for ANARO Coffee Blog
// Chỉ tập trung vào tag filtering, loại bỏ duplicate tags

let allPosts = [];
let filteredPosts = [];
let currentFilter = 'all';

// Hàm setup filter tags - loại bỏ duplicate
function setupFilters() {
  // Lấy tất cả posts từ DOM
  const blogCards = document.querySelectorAll('.blog-card');
  const allTags = new Set();
  
  blogCards.forEach(card => {
    const tagsAttr = card.getAttribute('data-tags');
    if (tagsAttr && tagsAttr.trim() !== '') {
      const tags = tagsAttr.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
      tags.forEach(tag => allTags.add(tag));
    }
  });
  
  const filterContainer = document.querySelector('.filter-tags');
  if (!filterContainer) return;
  
  // Xóa các tag cũ (trừ nút "Tất cả")
  const existingTags = filterContainer.querySelectorAll('.filter-tag:not([data-tag="all"])');
  existingTags.forEach(tag => tag.remove());
  
  // Tạo các nút filter mới (đã loại bỏ duplicate)
  const sortedTags = Array.from(allTags).sort();
  
  sortedTags.forEach(tag => {
    const button = document.createElement('button');
    button.className = 'filter-tag';
    button.dataset.tag = tag.toLowerCase();
    button.textContent = tag;
    button.style.cssText = `
      padding: 8px 16px; 
      border: 1px solid var(--border); 
      background: var(--white); 
      color: var(--brand); 
      border-radius: 20px; 
      cursor: pointer; 
      font-size: 0.9rem; 
      transition: all 0.3s;
    `;
    
    // Event listener cho tag filtering
    button.addEventListener('click', function() {
      // Reset tất cả nút về trạng thái không active
      document.querySelectorAll('.filter-tag').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = 'var(--white)';
        btn.style.color = 'var(--brand)';
      });
      
      // Active nút được click
      this.classList.add('active');
      this.style.background = 'var(--brand)';
      this.style.color = 'white';
      
      currentFilter = this.dataset.tag;
      filterPostsByTag();
    });
    
    filterContainer.appendChild(button);
  });
  
  // Setup nút "Tất cả"
  const allBtn = document.querySelector('.filter-tag[data-tag="all"]');
  if (allBtn) {
    allBtn.addEventListener('click', function() {
      document.querySelectorAll('.filter-tag').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = 'var(--white)';
        btn.style.color = 'var(--brand)';
      });
      
      this.classList.add('active');
      this.style.background = 'var(--brand)';
      this.style.color = 'white';
      
      currentFilter = 'all';
      filterPostsByTag();
    });
  }
}

// Hàm filter posts theo tag
function filterPostsByTag() {
  const blogCards = document.querySelectorAll('.blog-card');
  let visibleCount = 0;
  
  blogCards.forEach(card => {
    const tagsAttr = card.getAttribute('data-tags');
    
    // Ẩn demo cards (không có tags hoặc tags rỗng)
    if (!tagsAttr || tagsAttr.trim() === '') {
      card.style.display = 'none';
      return;
    }
    
    if (currentFilter === 'all') {
      card.style.display = 'block';
      visibleCount++;
    } else {
      const tags = tagsAttr.split(',').map(tag => tag.trim().toLowerCase());
      
      if (tags.includes(currentFilter.toLowerCase())) {
        card.style.display = 'block';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    }
  });
  
  // Hiển thị/ẩn trạng thái "không có kết quả"
  showNoResultsState(visibleCount === 0);
}

// Hàm hiển thị trạng thái không có kết quả
function showNoResultsState(show) {
  const noResults = document.getElementById('no-results');
  const emptyState = document.getElementById('empty-state');
  
  if (show && currentFilter !== 'all') {
    if (noResults) noResults.style.display = 'block';
    if (emptyState) emptyState.style.display = 'none';
  } else {
    if (noResults) noResults.style.display = 'none';
    if (emptyState && show) emptyState.style.display = 'block';
    else if (emptyState) emptyState.style.display = 'none';
  }
}

// Hàm click vào chip tag trong card
function filterByTag(tag) {
  const tagBtn = document.querySelector(`.filter-tag[data-tag="${tag.toLowerCase()}"]`);
  if (tagBtn) {
    tagBtn.click(); // Trigger click event
  }
}

// Hàm clear filter (reset về "Tất cả")
function clearFilters() {
  const allBtn = document.querySelector('.filter-tag[data-tag="all"]');
  if (allBtn) {
    allBtn.click();
  }
}

// Khởi tạo khi DOM ready
function initTagFiltering() {
  // Ẩn demo cards ngay lập tức
  const demoCards = document.querySelectorAll('.blog-card[data-tags=""]');
  demoCards.forEach(card => card.style.display = 'none');
  
  // Setup filtering
  setupFilters();
  
  // Set default active cho nút "Tất cả"
  const allBtn = document.querySelector('.filter-tag[data-tag="all"]');
  if (allBtn && !allBtn.classList.contains('active')) {
    allBtn.classList.add('active');
    allBtn.style.background = 'var(--brand)';
    allBtn.style.color = 'white';
  }
  
  console.log('[Tag Filtering] Initialized successfully');
}

// Auto-run khi script load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initTagFiltering);
} else {
  initTagFiltering();
}

// Export functions for global access
window.filterByTag = filterByTag;
window.clearFilters = clearFilters;
