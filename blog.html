// Unified UI Components - Thay th·∫ø logic render trong c√°c file hi·ªán t·∫°i
class BlogUIRenderer {
  constructor(blogManager) {
    this.manager = blogManager;
    this.elements = {};
    this.templates = {};
    this.eventListeners = new Set();
    
    this.initTemplates();
    this.bindEvents();
  }

  initTemplates() {
    // Card template v·ªõi better structure
    this.templates.postCard = (post) => `
      <article class="blog-card" data-post-id="${post.id}" data-tags="${post.tags.join(',').toLowerCase()}">
        <a class="card-link" href="post.html?slug=${post.slug}" aria-label="ƒê·ªçc b√†i: ${this.escapeHtml(post.title)}">
          <div class="badges">
            ${post.isNew ? '<span class="badge new">M·ªõi</span>' : ''}
            ${post.isHot ? '<span class="badge hot">Hot</span>' : ''}
            ${post.featured ? '<span class="badge featured">N·ªïi b·∫≠t</span>' : ''}
          </div>
          
          <div class="thumb ${post.cover ? '' : 'thumb--placeholder'}">
            ${post.cover 
              ? `<img src="${this.escapeHtml(post.cover)}" alt="${this.escapeHtml(post.title)}" loading="lazy" onerror="this.parentNode.className='thumb thumb--placeholder'; this.outerHTML='<span class=\\'placeholder-icon\\'>üìù</span>'">`
              : '<span class="placeholder-icon">üìù</span>'
            }
          </div>
          
          <div class="card-body">
            <h3 class="card-title">${this.escapeHtml(post.title)}</h3>
            <div class="meta">
              <span class="date">${this.formatDate(post.date)}</span>
              ${post.date ? ' ¬∑ ' : ''}
              <span class="read-time">${post.readTime} ph√∫t ƒë·ªçc</span>
              ${post.views > 0 ? ` ¬∑ <span class="view-count">${post.views} l∆∞·ª£t xem</span>` : ''}
            </div>
            <p class="desc">${this.escapeHtml(post.description)}</p>
            <div class="tags">
              ${post.tags.map(tag => 
                `<span class="chip" onclick="blogUI.filterByTag('${this.escapeHtml(tag)}')">${this.escapeHtml(tag)}</span>`
              ).join('')}
            </div>
          </div>
        </a>
      </article>
    `;

    // Pagination template
    this.templates.pagination = (data) => {
      if (data.totalPages <= 1) return '';
      
      let html = '<div class="pagination" role="navigation" aria-label="Ph√¢n trang b√†i vi·∫øt">';
      
      // Previous button
      html += `
        <button ${data.currentPage === 1 ? 'disabled' : ''} 
                onclick="blogUI.goToPage(${data.currentPage - 1})"
                aria-label="Trang tr∆∞·ªõc">
          <i class="fas fa-chevron-left"></i>
        </button>
      `;
      
      // Page numbers with smart ellipsis
      const pages = this.generatePageNumbers(data.currentPage, data.totalPages);
      pages.forEach(page => {
        if (page === '...') {
          html += '<span class="pagination-ellipsis">...</span>';
        } else {
          html += `
            <button class="${page === data.currentPage ? 'current' : ''}"
                    onclick="blogUI.goToPage(${page})"
                    aria-label="Trang ${page}"
                    ${page === data.currentPage ? 'aria-current="page"' : ''}>
              ${page}
            </button>
          `;
        }
      });
      
      // Next button
      html += `
        <button ${data.currentPage === data.totalPages ? 'disabled' : ''}
                onclick="blogUI.goToPage(${data.currentPage + 1})"
                aria-label="Trang sau">
          <i class="fas fa-chevron-right"></i>
        </button>
      `;
      
      html += '</div>';
      return html;
    };

    // Filter tags template
    this.templates.filterTags = (tags, currentFilter) => {
      let html = `
        <button class="filter-tag ${currentFilter === 'all' ? 'active' : ''}" 
                data-tag="all" onclick="blogUI.filterByTag('all')">
          T·∫•t c·∫£
        </button>
      `;
      
      tags.forEach(({ tag, count }) => {
        html += `
          <button class="filter-tag ${currentFilter === tag.toLowerCase() ? 'active' : ''}"
                  data-tag="${tag.toLowerCase()}" 
                  onclick="blogUI.filterByTag('${this.escapeHtml(tag)}')"
                  title="${count} b√†i vi·∫øt">
            ${this.escapeHtml(tag)} (${count})
          </button>
        `;
      });
      
      return html;
    };

    // Stats template
    this.templates.stats = (data) => `
      <div class="blog-stats">
        <span class="stat-item">
          üìù <strong>${data.totalCount}</strong> b√†i vi·∫øt
        </span>
        <span class="stat-item">
          üî• <strong>${data.hotCount}</strong> b√†i hot
        </span>
        <span class="stat-item">
          ‚ú® <strong>${data.newCount}</strong> b√†i m·ªõi
        </span>
        ${data.searchQuery ? `
        <span class="stat-item search-result">
          üîç K·∫øt qu·∫£ cho "<strong>${this.escapeHtml(data.searchQuery)}</strong>"
        </span>
        ` : ''}
      </div>
    `;

    // Loading template
    this.templates.loading = (message = 'ƒêang t·∫£i...') => `
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>${this.escapeHtml(message)}</p>
      </div>
    `;

    // Empty states
    this.templates.emptyState = () => `
      <div class="empty-state">
        <div class="empty-icon">üìù</div>
        <h3>Ch∆∞a c√≥ b√†i vi·∫øt n√†o</h3>
        <p>H√£y quay l·∫°i sau ƒë·ªÉ ƒë·ªçc nh·ªØng b√†i vi·∫øt m·ªõi nh·∫•t v·ªÅ c√† ph√™!</p>
      </div>
    `;

    this.templates.noResults = () => `
      <div class="no-results">
        <div class="empty-icon">üîç</div>
        <h3>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</h3>
        <p>Th·ª≠ t√¨m ki·∫øm v·ªõi t·ª´ kh√≥a kh√°c ho·∫∑c b·ªè b·ªô l·ªçc.</p>
        <button class="clear-filters-btn" onclick="blogUI.clearFilters()">
          X√≥a b·ªô l·ªçc
        </button>
      </div>
    `;

    // Error template
    this.templates.error = (error) => `
      <div class="error-state">
        <div class="error-icon">‚ö†Ô∏è</div>
        <h3>C√≥ l·ªói x·∫£y ra</h3>
        <p>${this.escapeHtml(error.message)}</p>
        <button class="retry-btn" onclick="blogUI.retry()">
          Th·ª≠ l·∫°i
        </button>
      </div>
    `;
  }

  // Bind events v√† setup DOM observers
  bindEvents() {
    // Listen to manager state changes
    this.manager.subscribe((event, data) => {
      switch (event) {
        case 'stateChange':
          this.onStateChange(data);
          break;
        case 'loadProgress':
          this.onLoadProgress(data);
          break;
      }
    });

    // Setup search input with debouncing
    this.setupSearchInput();
    
    // Setup intersection observer for infinite scroll (optional)
    this.setupIntersectionObserver();
  }

  setupSearchInput() {
    const searchInput = document.getElementById('search-input');
    if (!searchInput) return;

    let searchTimeout;
    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        this.manager.search(e.target.value.trim());
      }, 300);
    });

    // Clear search on Escape
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        e.target.value = '';
        this.manager.search('');
      }
    });
  }

  setupIntersectionObserver() {
    const loadMoreTarget = document.getElementById('load-more-target');
    if (!loadMoreTarget) return;

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && this.manager.state.hasMore) {
          this.loadMore();
        }
      });
    }, { threshold: 0.1 });

    observer.observe(loadMoreTarget);
  }

  // Event handlers
  onStateChange({ prevState, newState }) {
    // Only re-render if relevant state changed
    const needsGridUpdate = (
      prevState.filteredPosts !== newState.filteredPosts ||
      prevState.currentPage !== newState.currentPage ||
      prevState.loading !== newState.loading ||
      prevState.error !== newState.error
    );

    const needsFiltersUpdate = (
      prevState.posts !== newState.posts ||
      prevState.currentFilter !== newState.currentFilter
    );

    const needsStatsUpdate = (
      prevState.filteredPosts !== newState.filteredPosts ||
      prevState.searchQuery !== newState.searchQuery
    );

    if (needsGridUpdate) this.updateGrid();
    if (needsFiltersUpdate) this.updateFilters();
    if (needsStatsUpdate) this.updateStats();
  }

  onLoadProgress({ loaded, total }) {
    this.updateProgressBar(loaded, total);
  }

  // UI Update methods
  updateGrid() {
    const gridElement = document.getElementById('blog-grid');
    const paginationElement = document.getElementById('pagination');
    
    if (!gridElement) return;

    const { loading, error, filteredPosts } = this.manager.state;

    // Handle loading state
    if (loading) {
      gridElement.innerHTML = this.templates.loading();
      if (paginationElement) paginationElement.innerHTML = '';
      return;
    }

    // Handle error state
    if (error) {
      gridElement.innerHTML = this.templates.error(error);
      if (paginationElement) paginationElement.innerHTML = '';
      return;
    }

    // Handle empty states
    if (filteredPosts.length === 0) {
      const isEmpty = this.manager.state.posts.length === 0;
      gridElement.innerHTML = isEmpty 
        ? this.templates.emptyState() 
        : this.templates.noResults();
      if (paginationElement) paginationElement.innerHTML = '';
      return;
    }

    // Render posts
    const paginatedData = this.manager.getPaginatedPosts();
    gridElement.innerHTML = paginatedData.posts
      .map(post => this.templates.postCard(post))
      .join('');

    // Update pagination
    if (paginationElement) {
      paginationElement.innerHTML = this.templates.pagination(paginatedData);
    }

    // Show grid
    gridElement.classList.remove('hidden');
  }

  updateFilters() {
    const filterContainer = document.querySelector('.filter-tags');
    if (!filterContainer) return;

    const tags = this.manager.getAllTags();
    const currentFilter = this.manager.state.currentFilter;
    
    filterContainer.innerHTML = this.templates.filterTags(tags, currentFilter);
  }

  updateStats() {
    const statsElement = document.getElementById('blog-stats');
    if (!statsElement) return;

    const { filteredPosts, posts, searchQuery } = this.manager.state;
    
    const statsData = {
      totalCount: filteredPosts.length,
      hotCount: posts.filter(p => p.isHot).length,
      newCount: posts.filter(p => p.isNew).length,
      searchQuery
    };

    statsElement.innerHTML = this.templates.stats(statsData);
    statsElement.classList.toggle('hidden', filteredPosts.length === 0);
  }

  updateProgressBar(loaded, total) {
    const progressBar = document.getElementById('progress-bar');
    const statusElement = document.getElementById('status');
    
    if (progressBar) {
      const percentage = (loaded / total) * 100;
      progressBar.style.width = `${percentage}%`;
    }
    
    if (statusElement) {
      statusElement.textContent = `ƒêang t·∫£i b√†i vi·∫øt... (${loaded}/${total})`;
    }
  }

  // Public API methods
  goToPage(page) {
    this.manager.setPage(page);
    // Smooth scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  filterByTag(tag) {
    this.manager.filterByTag(tag);
    
    // Update search input if needed
    const searchInput = document.getElementById('search-input');
    if (searchInput && tag !== 'all') {
      searchInput.placeholder = `T√¨m trong "${tag}"...`;
    } else if (searchInput) {
      searchInput.placeholder = 'T√¨m ki·∫øm
